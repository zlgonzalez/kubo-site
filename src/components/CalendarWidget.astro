---
import fs from 'node:fs';
import path from 'node:path';
import { parse } from 'csv-parse/sync';

const calendarPath = path.join(process.cwd(), 'src/data/calendar.csv');
const fileContent = fs.readFileSync(calendarPath, 'utf-8');

const records = parse(fileContent, {
  columns: true,
  skip_empty_lines: true
});

interface CalendarEvent {
  Date: string;
  Title: string;
  Description?: string;
}

// Sort events by date
const events: CalendarEvent[] = records.sort((a: CalendarEvent, b: CalendarEvent) => {
  return new Date(a.Date).getTime() - new Date(b.Date).getTime();
});

// Helper to format date
const formatDate = (dateString: string) => {
  const options: Intl.DateTimeFormatOptions = { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    weekday: 'short'
  };
  return new Date(dateString).toLocaleDateString('en-US', options);
};
---

<div class="calendar-widget bg-white rounded-lg shadow-lg overflow-hidden border border-gray-100">
  <div class="bg-primary px-6 py-4">
    <h3 class="text-white text-xl font-bold flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      Upcoming Events
    </h3>
  </div>
  
  <div class="calendar-list divide-y divide-gray-100">
    {events.length > 0 ? (
      events.map((event, index) => (
        <div class={`calendar-event-item px-6 py-4 hover:bg-gray-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}`}>
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start">
            <div class="mb-1 sm:mb-0">
               <span class="font-bold text-gray-800 text-lg">{event.Title}</span>
               {event.Description && <p class="text-sm text-gray-500 mt-1">{event.Description}</p>}
            </div>
            <div class="text-primary font-medium whitespace-nowrap bg-primary/10 px-3 py-1 rounded text-sm">
              {formatDate(event.Date)}
            </div>
          </div>
        </div>
      ))
    ) : (
      <div class="px-6 py-8 text-center text-gray-500 italic">
        No upcoming events at this time.
      </div>
    )}
  </div>

  <div class="pagination-controls hidden px-6 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center text-sm">
      <button class="prev-btn px-3 py-1 rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
          &larr; Previous
      </button>
      <span class="page-info text-gray-600 font-medium">Page 1</span>
      <button class="next-btn px-3 py-1 rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
          Next &rarr;
      </button>
  </div>
</div>

<script>
  function setupPagination(widget) {
      const list = widget.querySelector('.calendar-list');
      const controls = widget.querySelector('.pagination-controls');
      const prevBtn = widget.querySelector('.prev-btn');
      const nextBtn = widget.querySelector('.next-btn');
      const pageInfo = widget.querySelector('.page-info');

      if (!list || !controls) return;

      const items = list.querySelectorAll('.calendar-event-item');
      if (items.length <= 5) {
          controls.classList.add('hidden');
          return;
      } else {
          controls.classList.remove('hidden');
      }

      const itemsPerPage = 5;
      let currentPage = 1;
      const totalPages = Math.ceil(items.length / itemsPerPage);

      function showPage(page) {
          const start = (page - 1) * itemsPerPage;
          const end = start + itemsPerPage;

          items.forEach((item, index) => {
              if (index >= start && index < end) {
                  item.style.display = 'block';
              } else {
                  item.style.display = 'none';
              }
          });

          if(pageInfo) pageInfo.textContent = `Page ${page} of ${totalPages}`;
          if(prevBtn) prevBtn.disabled = page === 1;
          if(nextBtn) nextBtn.disabled = page === totalPages;
      }

      if(prevBtn) {
          prevBtn.addEventListener('click', () => {
              if (currentPage > 1) {
                  currentPage--;
                  showPage(currentPage);
              }
          });
      }

      if(nextBtn) {
          nextBtn.addEventListener('click', () => {
              if (currentPage < totalPages) {
                  currentPage++;
                  showPage(currentPage);
              }
          });
      }

      // Initialize
      showPage(1);
  }

  // Run on load and on Astro page transitions if present
  document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.calendar-widget').forEach(setupPagination);
  });
</script>
